<!doctype html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <script>
         let WASI, browserBindings, WasmFs, Llc, Lld, sysroot

         const compileAndRun = async () => {
             const mainLl = document.getElementById('input').value

             const wasmFs = new WasmFs()
             const wasi = new WASI({
                 bindings: {
                     ...browserBindings,
                     fs: wasmFs.fs,
                 }
             })

             const llc = await Llc()
             llc.FS.writeFile('main.ll', mainLl)
             await llc.callMain(['-filetype=obj', 'main.ll'])
             const mainO = llc.FS.readFile('main.o')

             const lld = await Lld()
             lld.FS.writeFile('main.o', mainO)

             { // untar sysroot to lld's FS
                 let offset = 0;

                 const readStr = (len = -1) => {
                     let str = ''
                     let end = sysroot.length
                     if (len != -1) { end = offset + len }
                     for (let i = offset; i < end && sysroot[i] != 0; ++i) { str += String.fromCharCode(sysroot[i]) }

                     offset += len;
                     return str;
                 }

                 const readOctal = (len) => {
                     return parseInt(readStr(len), 8);
                 }

                 const alignUp = () => {
                     offset = (offset + 511) & ~511;
                 }

                 const readEntry = () => {
                     if (offset + 512 > sysroot.length) {
                         return null;
                     }

                     const entry = {
                         filename : readStr(100),
                         mode : readOctal(8),
                         owner : readOctal(8),
                         group : readOctal(8),
                         size : readOctal(12),
                         mtim : readOctal(12),
                         checksum : readOctal(8),
                         type : readStr(1),
                         linkname : readStr(100),
                     };

                     if (!readStr(8).startsWith('ustar')) {
                         return null;
                     }

                     entry.ownerName = readStr(32);
                     entry.groupName = readStr(32);
                     entry.devMajor = readStr(8);
                     entry.devMinor = readStr(8);
                     entry.filenamePrefix = readStr(155);
                     alignUp();

                     if (entry.type === '0') {        // Regular file.
                         entry.contents = sysroot.subarray(offset, offset + entry.size);
                         offset += entry.size;
                         alignUp();
                     } else if (entry.type !== '5') { // Directory.
                         console.log('type', entry.type);
                         assert(false);
                     }
                     return entry;
                 }

                 let entry;
                 while (entry = readEntry()) {
                     switch (entry.type) {
                         case '0': // Regular file.
                             lld.FS.writeFile(entry.filename, entry.contents);
                             break;
                         case '5':
                             lld.FS.mkdir(entry.filename);
                             break;
                         default:
                             break;
                     }
                 }
             }

             await lld.callMain([
                 '-flavor',
                 'wasm',
                 '-L/lib',
                 '-lc',
                 '-lc++',
                 '-lc++abi',
                 '/lib/clang/11.0.0/lib/wasi/libclang_rt.builtins-wasm32.a',
                 '/lib/crt1.o',
                 'main.o',
                 '-o',
                 'main.wasm',
             ])
             const mainWasm = lld.FS.readFile('main.wasm')

             const module = await WebAssembly.compile(mainWasm)
             const instance = await WebAssembly.instantiate(module, {
                 ...wasi.getImports(module)
             })

             wasi.start(instance)
             const stdout = await wasmFs.getStdOut()
             document.getElementById('output').value = stdout
         }

         window.onload = async () => {
             WASI = (await import('https://unpkg.com/@wasmer/wasi@0.12.0/lib/index.esm.js')).WASI
             browserBindings = (await import('./browserBindings.js')).default
             WasmFs = (await import('https://unpkg.com/@wasmer/wasmfs@0.12.0/lib/index.esm.js')).WasmFs
             Llc = (await import('./llc.js')).default
             Lld = (await import('./lld.js')).default
             sysroot = await fetch('sysroot.tar')
                 .then(res => res.arrayBuffer())
                 .then(buf => new Uint8Array(buf));
         }
        </script>
    </head>
    <body>
        <textarea id="input" cols="80" rows="24" spellcheck="false">
; ModuleID = 'main.c'
source_filename = "main.c"
target datalayout = "e-m:e-p:32:32-i64:64-n32:64-S128"
target triple = "wasm32-unknown-wasi"

@.str = private unnamed_addr constant [13 x i8] c"Hello wasm!\0A\00", align 1
@llvm.used = appending global [1 x i8*] [i8* bitcast (i32 ()* @__main_void to i8*)], section "llvm.metadata"

@__main_void = alias i32 (), i32 ()* @main

; Function Attrs: noinline nounwind optnone
define i32 @main() #0 {
entry:
  %call = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([13 x i8], [13 x i8]* @.str, i32 0, i32 0))
  ret i32 0
}

declare i32 @printf(i8*, ...) #1

attributes #0 = { noinline nounwind optnone "correctly-rounded-divide-sqrt-fp-math"="false" "disable-tail-calls"="false" "frame-pointer"="none" "less-precise-fpmad"="false" "min-legal-vector-width"="0" "no-infs-fp-math"="false" "no-jump-tables"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "stack-protector-buffer-size"="8" "unsafe-fp-math"="false" "use-soft-float"="false" }
attributes #1 = { "correctly-rounded-divide-sqrt-fp-math"="false" "disable-tail-calls"="false" "frame-pointer"="none" "less-precise-fpmad"="false" "no-infs-fp-math"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "stack-protector-buffer-size"="8" "unsafe-fp-math"="false" "use-soft-float"="false" }

!llvm.module.flags = !{!0}
!llvm.ident = !{!1}

!0 = !{i32 1, !"wchar_size", i32 4}
!1 = !{!"clang version 11.1.0"}
        </textarea>
        <br/>
        <input id="compile-and-run" value="Compile and run" type="button" onclick="compileAndRun()">
        <br/>
        <textarea id="output" cols="80" rows="24" spellcheck="false"></textarea>
    </body>
</html>
